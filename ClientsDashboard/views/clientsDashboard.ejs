<!--
 * QOLAE Clients Dashboard
 * Secure workspace for consent, documents, appointments, reports
 * Organized by Location Block Protocol
 * Author: Liz
 * Date: 26th December 2025
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Dashboard - QOLAE Portal</title>
    <meta name="csrf-token" content="<%= csrfToken %>">

<!-- ========================================== -->
<!-- LOCATION BLOCK 0: ALL CSS STYLES -->
<!-- ========================================== -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header Card */
        .header-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 6px solid #4facfe;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
        }

        .logo-section {
            flex: 1;
        }

        .logo {
            max-height: 60px;
            width: auto;
            margin-bottom: 8px;
        }

        .tagline {
            color: #6c7293;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 12px;
            background: #f7fafc;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .notification-bell:hover {
            background: #e8f0ff;
            transform: translateY(-2px);
        }

        .notification-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        .security-badges {
            display: flex;
            gap: 12px;
        }

        .badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .badge-secure {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
        }

        .badge-gdpr {
            background: linear-gradient(135deg, #0984e3, #74b9ff);
            color: white;
        }

        .badge-blockchain {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
        }

        .welcome-section {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);
            padding: 25px;
            border-radius: 15px;
            border-left: 4px solid #4facfe;
        }

        .welcome-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .welcome-subtitle {
            color: #6c7293;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .session-info {
            display: flex;
            gap: 30px;
            font-size: 0.9rem;
            color: #6c7293;
        }

        .session-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Progress Section */
        .progress-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .progress-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 30px;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .step-circle.active {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
            animation: pulse-step 2s infinite;
        }

        .step-circle.completed {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
        }

        .step-circle.pending {
            background: #e2e8f0;
            color: #a0aec0;
        }

        .step-label {
            font-size: 0.85rem;
            color: #6c7293;
            text-align: center;
            max-width: 80px;
        }

        .progress-line {
            position: absolute;
            top: 25px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e2e8f0;
            z-index: 1;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            border-radius: 1px;
            transition: width 0.8s ease;
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .workflow-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .workflow-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .card-icon svg {
            width: 28px;
            height: 28px;
        }

        .card-icon.consent {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }

        .card-icon.documents {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .card-icon.appointment {
            background: linear-gradient(135deg, #ffd89b, #19547b);
        }

        .card-icon.report {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
        }

        .card-icon.support {
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d3748;
        }

        .card-description {
            color: #6c7293;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .card-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffd89b, #19547b);
            color: white;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-pending {
            background: #fff5f5;
            color: #c53030;
            border: 1px solid #fed7d7;
        }

        .status-active {
            background: #f0fff4;
            color: #38a169;
            border: 1px solid #c6f6d5;
        }

        .status-completed {
            background: #ebf8ff;
            color: #3182ce;
            border: 1px solid #bee3f8;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: blink 2s infinite;
        }

        .status-pending .status-dot {
            background: #c53030;
        }

        .status-active .status-dot {
            background: #38a169;
        }

        .status-completed .status-dot {
            background: #3182ce;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #2d3748;
        }

        .close-btn {
            font-size: 2rem;
            color: #a0aec0;
            cursor: pointer;
            border: none;
            background: none;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #2d3748;
        }

        .consent-form {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f7fafc;
            max-height: 300px;
            overflow-y: auto;
        }

        .consent-form h3 {
            color: #2d3748;
            margin-bottom: 10px;
        }

        .consent-form p {
            color: #6c7293;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .signature-section {
            margin: 20px 0;
        }

        .signature-canvas {
            border: 2px dashed #4facfe;
            border-radius: 10px;
            width: 100%;
            height: 150px;
            cursor: crosshair;
            background: white;
        }

        .signature-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            color: #2d3748;
            font-weight: 500;
        }

        /* Notification Panel */
        .notification-panel {
            display: none;
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 350px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 999;
            animation: slideInRight 0.3s;
        }

        .notification-panel.show {
            display: block;
        }

        .notification-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f7fafc;
            transition: background 0.2s;
            cursor: pointer;
        }

        .notification-item:hover {
            background: #f7fafc;
        }

        .notification-item.unread {
            background: #f0fff4;
        }

        .notification-time {
            font-size: 0.75rem;
            color: #a0aec0;
            margin-top: 5px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.5s ease;
            z-index: 1001;
            max-width: 350px;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-success {
            background: linear-gradient(135deg, #00b894, #00cec9);
        }

        .toast-info {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }

        .toast-warning {
            background: linear-gradient(135deg, #ffd89b, #19547b);
        }

        /* Ripple Effect */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: scale(0);
            animation: ripple-animation 0.6s linear;
            pointer-events: none;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes pulse-step {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Footer */
        .footer-notice {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #ffd89b;
        }

        .notice-content {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #744210;
            font-size: 0.9rem;
        }

        .footer-links {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .copyright {
            color: #6c7293;
            font-size: 0.9rem;
        }

        .footer-nav {
            display: flex;
            gap: 25px;
        }

        .footer-nav a {
            color: #4facfe;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        .footer-nav a:hover {
            color: #2d3748;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .header-top {
                flex-direction: column;
                gap: 20px;
            }

            .session-info {
                flex-direction: column;
                gap: 10px;
            }

            .progress-steps {
                flex-wrap: wrap;
                gap: 15px;
                justify-content: center;
            }

            .progress-line {
                display: none;
            }

            .card-buttons {
                flex-direction: column;
            }

            .footer-links {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .footer-nav {
                justify-content: center;
            }

            .notification-panel {
                right: 10px;
                left: 10px;
                width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">

<!-- ========================================== -->
<!-- LOCATION BLOCK 1: HEADER CARD -->
<!-- ========================================== -->
        <div class="header-card">
            <div class="header-top">
                <div class="logo-section">
                    <img src="/public/images/qolaeNewLogo.png" alt="QOLAE" class="logo">
                    <div class="tagline">Secure Legal Document Management</div>
                    <div class="security-badges">
                        <div class="badge badge-secure">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1M10,17L6,13L7.41,11.59L10,14.17L16.59,7.58L18,9L10,17Z"/>
                            </svg>
                            Secure
                        </div>
                        <div class="badge badge-gdpr">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9,10H7V12H9V10M13,10H11V12H13V10M17,10H15V12H17V10M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,19H5V8H19V19Z"/>
                            </svg>
                            GDPR Compliant
                        </div>
                        <div class="badge badge-blockchain">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1Z"/>
                            </svg>
                            Blockchain Secured
                        </div>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="notification-bell" onclick="toggleNotifications()">
                        <svg width="24" height="24" fill="#4facfe" viewBox="0 0 24 24">
                            <path d="M21,19V20H3V19L5,17V11C5,7.9 7.03,5.17 10,4.29C10,4.19 10,4.1 10,4A2,2 0 0,1 12,2A2,2 0 0,1 14,4C14,4.1 14,4.19 14,4.29C16.97,5.17 19,7.9 19,11V17L21,19M14,21A2,2 0 0,1 12,23A2,2 0 0,1 10,21"/>
                        </svg>
                        <% if (notifications.unreadCount > 0) { %>
                        <span class="notification-badge"><%= notifications.unreadCount %></span>
                        <% } %>
                    </div>
                </div>
            </div>
            <div class="welcome-section">
                <div class="welcome-title">Welcome <%= client.firstName %></div>
                <div class="welcome-subtitle">Access your secure legal workflow portal. Your consent process is in progress and all communications are encrypted.</div>
                <div class="session-info">
                    <div class="session-item">
                        <svg width="16" height="16" fill="#4facfe" viewBox="0 0 24 24">
                            <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.2,16.2L11,13V7H12.5V12.2L17,14.9L16.2,16.2Z"/>
                        </svg>
                        <span>Last login: <%= session.lastLogin %></span>
                    </div>
                    <div class="session-item">
                        <svg width="16" height="16" fill="#00b894" viewBox="0 0 24 24">
                            <path d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1M10,17L6,13L7.41,11.59L10,14.17L16.59,7.58L18,9L10,17Z"/>
                        </svg>
                        Session: Encrypted & Secure
                    </div>
                    <div class="session-item">
                        <svg width="16" height="16" fill="#667eea" viewBox="0 0 24 24">
                            <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/>
                        </svg>
                        Client ID: <%= client.id %>
                    </div>
                </div>
            </div>
        </div>

<!-- ========================================== -->
<!-- LOCATION BLOCK 2: NOTIFICATION PANEL -->
<!-- ========================================== -->
        <div class="notification-panel" id="notificationPanel">
            <div class="notification-header">
                <h3 style="margin: 0; color: #2d3748;">Notifications</h3>
                <button class="close-btn" onclick="toggleNotifications()" style="font-size: 1.5rem;">&times;</button>
            </div>
            <% notifications.items.forEach(function(notif) { %>
            <div class="notification-item <%= notif.read ? '' : 'unread' %>" onclick="markAsRead(this, '<%= notif.id %>')">
                <strong style="color: #2d3748;"><%= notif.title %></strong>
                <p style="color: #6c7293; font-size: 0.9rem; margin: 5px 0;"><%= notif.message %></p>
                <div class="notification-time"><%= notif.timeAgo %></div>
            </div>
            <% }); %>
            <% if (notifications.items.length === 0) { %>
            <div style="padding: 20px; text-align: center; color: #6c7293;">
                No notifications yet
            </div>
            <% } %>
        </div>

<!-- ========================================== -->
<!-- LOCATION BLOCK 3: PROGRESS SECTION -->
<!-- ========================================== -->
        <div class="progress-section">
            <div class="progress-title">Your Workflow Progress</div>
            <div class="progress-steps">
                <div class="progress-line">
                    <div class="progress-fill" id="progressFill" style="width: <%= progressPercentage %>%;"></div>
                </div>
                
                <% workflow.steps.forEach(function(step, index) { %>
                <div class="progress-step">
                    <div class="step-circle <%= step.status %>" title="<%= step.statusLabel %>">
                        <% if (step.status === 'completed') { %>‚úì<% } else { %><%= index + 1 %><% } %>
                    </div>
                    <div class="step-label"><%= step.label %></div>
                </div>
                <% }); %>
            </div>
        </div>

<!-- ========================================== -->
<!-- LOCATION BLOCK 4: WORKFLOW CARDS GRID -->
<!-- ========================================== -->
        <div class="cards-grid">

            <!-- Consent Form Card -->
            <div class="workflow-card">
                <div class="card-header">
                    <div class="card-icon consent">
                        <svg fill="white" viewBox="0 0 24 24">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                    </div>
                    <div>
                        <div class="card-title">Consent Form</div>
                        <div class="status-indicator status-<%= cards.consentForm.status === 'completed' ? 'completed' : 'active' %>">
                            <div class="status-dot"></div>
                            <%= cards.consentForm.statusLabel %>
                        </div>
                    </div>
                </div>
                <div class="card-description">
                    Review and sign your consent form to proceed with your case. You can sign digitally within the portal or download, print, and upload the signed document.
                </div>
                <div class="card-buttons">
                    <% if (!cards.consentForm.signed) { %>
                    <button class="btn btn-primary" onclick="openSignModal()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M9,16.2L4.8,12L3.4,13.4L9,19L21,7L19.6,5.6L9,16.2Z"/>
                        </svg>
                        Sign Digitally
                    </button>
                    <% } %>
                    <button class="btn btn-secondary" onclick="downloadForm()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        <%= cards.consentForm.signed ? 'View Signed Copy' : 'Download Copy' %>
                    </button>
                </div>
            </div>

            <!-- INA Appointment Card -->
            <div class="workflow-card">
                <div class="card-header">
                    <div class="card-icon appointment">
                        <svg fill="white" viewBox="0 0 24 24">
                            <path d="M9,10H7V12H9V10M13,10H11V12H13V10M17,10H15V12H17V10M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,19H5V8H19V19Z"/>
                        </svg>
                    </div>
                    <div>
                        <div class="card-title">INA Appointment</div>
                        <div class="status-indicator status-<%= cards.inaAppointment.status === 'completed' ? 'completed' : (cards.inaAppointment.status === 'active' ? 'active' : 'pending') %>">
                            <div class="status-dot"></div>
                            <%= cards.inaAppointment.statusLabel %>
                        </div>
                    </div>
                </div>
                <div class="card-description">
                    Your Independent Neuropsychological Assessment appointment will be scheduled once your consent form is processed. You'll receive confirmation details and preparation instructions.
                </div>
                <div class="card-buttons">
                    <button class="btn btn-secondary" id="viewApptBtn" <%= cards.inaAppointment.canSchedule ? '' : 'disabled' %>>
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,19H5V8H19V19Z"/>
                        </svg>
                        <%= cards.inaAppointment.scheduled ? 'View Appointment' : 'Schedule Appointment' %>
                    </button>
                </div>
            </div>

            <!-- Document Access Card -->
            <div class="workflow-card">
                <div class="card-header">
                    <div class="card-icon documents">
                        <svg fill="white" viewBox="0 0 24 24">
                            <path d="M6,2C4.89,2 4,2.89 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2H6M13,3.5L18.5,9H13V3.5Z"/>
                        </svg>
                    </div>
                    <div>
                        <div class="card-title">Document Access</div>
                        <div class="status-indicator status-<%= cards.documentAccess.status === 'active' ? 'active' : 'pending' %>">
                            <div class="status-dot"></div>
                            <%= cards.documentAccess.statusLabel %>
                        </div>
                    </div>
                </div>
                <div class="card-description">
                    Access your case documents and communications securely. Document access will be unlocked once your signed consent form is received and verified.
                </div>
                <div class="card-buttons">
                    <button class="btn btn-secondary" id="viewDocsBtn" <%= cards.documentAccess.enabled ? '' : 'disabled' %> onclick="viewDocuments()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M13,9H18.5L13,3.5V9M6,2H14L20,8V20A2,2 0 0,1 18,22H6C4.89,22 4,21.1 4,20V4C4,2.89 4.89,2 6,2M15,18V16H6V18H15M18,14V12H6V14H18Z"/>
                        </svg>
                        View Documents
                    </button>
                </div>
            </div>

            <!-- Final Report Card -->
            <div class="workflow-card">
                <div class="card-header">
                    <div class="card-icon report">
                        <svg fill="white" viewBox="0 0 24 24">
                            <path d="M14,17H7V15H14M17,13H7V11H17M17,9H7V7H17M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3Z"/>
                        </svg>
                    </div>
                    <div>
                        <div class="card-title">Final Report</div>
                        <div class="status-indicator status-<%= cards.finalReport.status === 'completed' ? 'completed' : 'pending' %>">
                            <div class="status-dot"></div>
                            <%= cards.finalReport.statusLabel %>
                        </div>
                    </div>
                </div>
                <div class="card-description">
                    Your final assessment report will be available once the INA is completed. You'll be notified when the report is ready and can discuss findings with your legal team.
                </div>
                <div class="card-buttons">
                    <button class="btn btn-secondary" <%= cards.finalReport.available ? '' : 'disabled' %> onclick="viewReport()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        View Report
                    </button>
                </div>
            </div>

        </div>

<!-- ========================================== -->
<!-- LOCATION BLOCK 5: FOOTER -->
<!-- ========================================== -->
        <div class="footer-notice">
            <div class="notice-content">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1M10,17L6,13L7.41,11.59L10,14.17L16.59,7.58L18,9L10,17Z"/>
                </svg>
                Security Notice: All data is encrypted in transit and at rest. This system is GDPR compliant, blockchain-secured, and maintains strict audit trails for all actions.
            </div>
        </div>

        <div class="footer-links">
            <div class="copyright">¬© 2025 QOLAE. All rights reserved. Secure legal document management.</div>
            <div class="footer-nav">
                <a href="#" onclick="showToast('Privacy Policy - Coming soon', 'info'); return false;">Privacy Policy</a>
                <a href="#" onclick="showToast('Terms of Service - Coming soon', 'info'); return false;">Terms of Service</a>
                <a href="/logout">Logout</a>
            </div>
        </div>
    </div>

<!-- ========================================== -->
<!-- LOCATION BLOCK 6: CONSENT FORM MODAL -->
<!-- ========================================== -->
    <div id="signModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">Consent Form - Client Agreement</div>
                <button class="close-btn" onclick="closeSignModal()">&times;</button>
            </div>
            
            <!-- CLIENT INFO HEADER -->
            <div style="background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #4facfe;">
                <p style="margin: 5px 0; color: #2d3748;"><strong>Client Name:</strong> <%= client.name %></p>
                <p style="margin: 5px 0; color: #2d3748;"><strong>Case Reference:</strong> <%= client.id %></p>
                <p style="margin: 5px 0; color: #2d3748;"><strong>Date:</strong> <span id="consentDate"></span></p>
            </div>

            <!-- SERVER-SIDE FORM SUBMISSION -->
            <form method="POST" action="/api/consent/sign" id="consentForm">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                
                <div style="max-height: 60vh; overflow-y: auto; padding: 10px;">
                    
                    <!-- ============================================ -->
                    <!-- SECTION 1: Consent for INA -->
                    <!-- ============================================ -->
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #8b5cf6;">
                        <h4 style="color: #1e293b; margin-bottom: 15px; font-size: 1rem;">
                            üìã Section 1: Consent for Immediate Needs Assessment (INA)
                        </h4>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="inaConsentA" value="true" style="margin-top: 4px;" required>
                                <span style="color: #475569; line-height: 1.6; font-size: 0.95rem;">
                                    <strong>1A:</strong> I, <em><%= client.name %></em>, consent to the Immediate Needs Assessment conducted by <em>Liz Chukwu</em>, including the collection of personal and clinical information necessary to assess my injury/injuries for potential rehabilitation and future healthcare needs.
                                </span>
                            </label>
                            <!-- TODO: Add clarifying text when "No" is selected - Design needed for "Why are you declining?" message -->
                        </div>
                        
                        <div>
                            <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="inaConsentB" value="true" style="margin-top: 4px;" required>
                                <span style="color: #475569; line-height: 1.6; font-size: 0.95rem;">
                                    <strong>1B:</strong> I understand the purpose of this assessment is to develop a tailored set of recommendations for my clinical and rehabilitation needs, as well as to provide a report for my legal team that may be used in a court of law.
                                </span>
                            </label>
                            <!-- TODO: Add clarifying text when "No" is selected - Design needed for "Why are you declining?" message -->
                        </div>
                    </div>

                    <!-- ============================================ -->
                    <!-- SECTION 2: Ongoing Case Management -->
                    <!-- ============================================ -->
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #10b981;">
                        <h4 style="color: #1e293b; margin-bottom: 15px; font-size: 1rem;">
                            üë®‚Äç‚öïÔ∏è Section 2: Consent for Potential Ongoing Case Management
                        </h4>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="ongoingCaseManagementConsentA" value="true" style="margin-top: 4px;" required>
                                <span style="color: #475569; line-height: 1.6; font-size: 0.95rem;">
                                    <strong>2A:</strong> I consent to potential ongoing case management, reassessment, or evaluation of my rehabilitation and healthcare needs as requested by my legal team or deemed necessary by <em>Liz Chukwu</em>/QOLAE.
                                </span>
                            </label>
                            <!-- TODO: Add clarifying text when "No" is selected - Design needed for "Why are you declining?" message -->
                        </div>
                        
                        <div>
                            <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="ongoingCaseManagementConsentB" value="true" style="margin-top: 4px;" required>
                                <span style="color: #475569; line-height: 1.6; font-size: 0.95rem;">
                                    <strong>2B:</strong> I understand that this consent includes, but is not limited to:
                                    <ul style="margin: 8px 0 0 20px; padding: 0;">
                                        <li>Urgent interventions such as medication reviews or consultations with my GP</li>
                                        <li>Updates or changes to recommendations based on my progress or evolving healthcare needs</li>
                                        <li>Additional assessments as required to provide further recommendations to my legal team</li>
                                    </ul>
                                </span>
                            </label>
                            <!-- TODO: Add clarifying text when "No" is selected - Design needed for "Why are you declining?" message -->
                        </div>
                    </div>

                    <!-- ============================================ -->
                    <!-- SECTION 3: Medical Notes Access -->
                    <!-- ============================================ -->
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                        <h4 style="color: #1e293b; margin-bottom: 15px; font-size: 1rem;">
                            üè• Section 3: Consent for Access to Medical Notes
                        </h4>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="medicalNotesConsentA" value="true" style="margin-top: 4px;" required>
                                <span style="color: #475569; line-height: 1.6; font-size: 0.95rem;">
                                    <strong>3A:</strong> I consent to <em>Liz Chukwu</em>/QOLAE accessing my medical notes as provided by my legal representatives for the purposes of completing the Immediate Needs Assessment and any potential ongoing case management, reassessment, or evaluation.
                                </span>
                            </label>
                            <!-- TODO: Add clarifying text when "No" is selected - Design needed for "Why are you declining?" message -->
                        </div>
                        
                        <div>
                            <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="medicalNotesConsentB" value="true" style="margin-top: 4px;" required>
                                <span style="color: #475569; line-height: 1.6; font-size: 0.95rem;">
                                    <strong>3B:</strong> I understand that this consent is specific to QOLAE's role and does not extend to sharing my medical information with other parties without my explicit written permission.
                                </span>
                            </label>
                            <!-- TODO: Add clarifying text when "No" is selected - Design needed for "Why are you declining?" message -->
                        </div>
                    </div>

                    <!-- ============================================ -->
                    <!-- SECTION 4: Healthcare Collaboration -->
                    <!-- ============================================ -->
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                        <h4 style="color: #1e293b; margin-bottom: 15px; font-size: 1rem;">
                            üë• Section 4: Consent for Collaboration with Healthcare Practitioners
                        </h4>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="healthcareCollaborationConsentA" value="true" style="margin-top: 4px;" required>
                                <span style="color: #475569; line-height: 1.6; font-size: 0.95rem;">
                                    <strong>4A:</strong> I consent to <em>Liz Chukwu</em>/QOLAE collaborating with the following professionals, as necessary, to assess and provide recommendations for my rehabilitation and healthcare needs:
                                    <ul style="margin: 8px 0 0 20px; padding: 0;">
                                        <li>Medical Specialists</li>
                                        <li>Nurse Specialists</li>
                                        <li>Physiotherapists</li>
                                        <li>Speech Therapists</li>
                                        <li>Occupational Therapists</li>
                                        <li>Other relevant Healthcare Practitioners</li>
                                    </ul>
                                </span>
                            </label>
                            <!-- TODO: Add clarifying text when "No" is selected - Design needed for "Why are you declining?" message -->
                        </div>
                        
                        <div>
                            <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="healthcareCollaborationConsentB" value="true" style="margin-top: 4px;" required>
                                <span style="color: #475569; line-height: 1.6; font-size: 0.95rem;">
                                    <strong>4B:</strong> I understand that such collaboration will be conducted strictly within the scope of my care and rehabilitation needs and for the purpose of providing recommendations to my legal team.
                                </span>
                            </label>
                            <!-- TODO: Add clarifying text when "No" is selected - Design needed for "Why are you declining?" message -->
                        </div>
                    </div>

                    <!-- ============================================ -->
                    <!-- SECTION 5: Documentation (Photographs & Recordings) -->
                    <!-- ============================================ -->
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ec4899;">
                        <h4 style="color: #1e293b; margin-bottom: 15px; font-size: 1rem;">
                            üì∑ Section 5: Consent for Documentation (Photographs & Recordings)
                        </h4>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="documentationConsentA" value="true" style="margin-top: 4px;" required>
                                <span style="color: #475569; line-height: 1.6; font-size: 0.95rem;">
                                    <strong>5A:</strong> I consent to the use of photographs, audio recordings, or written documentation taken during the INA, potential reassessments, or evaluations as part of the assessment process.
                                </span>
                            </label>
                            <!-- TODO: Add clarifying text when "No" is selected - Design needed for "Why are you declining?" message -->
                        </div>
                        
                        <div>
                            <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="documentationConsentB" value="true" style="margin-top: 4px;" required>
                                <span style="color: #475569; line-height: 1.6; font-size: 0.95rem;">
                                    <strong>5B:</strong> I understand that these materials will be securely stored by QOLAE and used solely for assessment purposes, including the preparation of reports that may be submitted to my legal team or in a court of law.
                                </span>
                            </label>
                            <!-- TODO: Add clarifying text when "No" is selected - Design needed for "Why are you declining?" message -->
                        </div>
                    </div>

                    <!-- ============================================ -->
                    <!-- SECTION 6: Reports and Reviews -->
                    <!-- ============================================ -->
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #6366f1;">
                        <h4 style="color: #1e293b; margin-bottom: 15px; font-size: 1rem;">
                            üìÑ Section 6: Consent for Reports and Reviews
                        </h4>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="reportsConsentA" value="true" style="margin-top: 4px;" required>
                                <span style="color: #475569; line-height: 1.6; font-size: 0.95rem;">
                                    <strong>6A:</strong> I understand that QOLAE will prepare a report following INA visit and any necessary reassessments.
                                </span>
                            </label>
                            <!-- TODO: Add clarifying text when "No" is selected - Design needed for "Why are you declining?" message -->
                        </div>
                        
                        <div>
                            <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="reportsConsentB" value="true" style="margin-top: 4px;" required>
                                <span style="color: #475569; line-height: 1.6; font-size: 0.95rem;">
                                    <strong>6B:</strong> I consent to QOLAE sharing this report with my legal team. I acknowledge that the report may include recommendations for overall holistic Rehabilitation and Care.
                                </span>
                            </label>
                            <!-- TODO: Add clarifying text when "No" is selected - Design needed for "Why are you declining?" message -->
                        </div>
                    </div>

                    <!-- ============================================ -->
                    <!-- SECTION 7: Legal Reporting Consent -->
                    <!-- ============================================ -->
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #14b8a6;">
                        <h4 style="color: #1e293b; margin-bottom: 15px; font-size: 1rem;">
                            ‚öñÔ∏è Section 7: Legal Reporting Consent
                        </h4>
                        
                        <div>
                            <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="legalReportingConsent" value="true" style="margin-top: 4px;" required>
                                <span style="color: #475569; line-height: 1.6; font-size: 0.95rem;">
                                    <strong>7:</strong> Information gathered during assessments will be used to create reports for my legal team, which will/may be presented in a court of law as/if required. I consent to the use of the INA report in legal proceedings, including submission to lawyers and a court of law, as required.
                                </span>
                            </label>
                            <!-- TODO: Add clarifying text when "No" is selected - Design needed for "Why are you declining?" message -->
                        </div>
                    </div>

                    <!-- ============================================ -->
                    <!-- SECTION 8: Data Protection and Confidentiality -->
                    <!-- ============================================ -->
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #8b5cf6;">
                        <h4 style="color: #1e293b; margin-bottom: 15px; font-size: 1rem;">
                            üõ°Ô∏è Section 8: Data Protection and Confidentiality
                        </h4>
                        
                        <div>
                            <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="dataProtectionConsent" value="true" style="margin-top: 4px;" required>
                                <span style="color: #475569; line-height: 1.6; font-size: 0.95rem;">
                                    <strong>8:</strong> I understand and acknowledge that:
                                    <ul style="margin: 8px 0 0 20px; padding: 0;">
                                        <li>QOLAE will handle all personal data in compliance with GDPR and the Data Protection Act 2018</li>
                                        <li>Information shared will only be used for the purposes stated above</li>
                                        <li>My data will not be shared with third parties without my explicit written consent, except as required by law</li>
                                    </ul>
                                </span>
                            </label>
                            <!-- TODO: Add clarifying text when "No" is selected - Design needed for "Why are you declining?" message -->
                        </div>
                    </div>

                    <!-- ============================================ -->
                    <!-- SECTION 9: Right to Withdraw Consent -->
                    <!-- ============================================ -->
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f97316;">
                        <h4 style="color: #1e293b; margin-bottom: 15px; font-size: 1rem;">
                            üîÑ Section 9: Right to Withdraw Consent
                        </h4>
                        
                        <div>
                            <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="withdrawalRightsConsent" value="true" style="margin-top: 4px;" required>
                                <span style="color: #475569; line-height: 1.6; font-size: 0.95rem;">
                                    <strong>9:</strong> I understand that:
                                    <ul style="margin: 8px 0 0 20px; padding: 0;">
                                        <li>I may withdraw my consent at any time by notifying QOLAE in writing</li>
                                        <li>Withdrawal of consent will not affect any assessments or services provided prior to the withdrawal</li>
                                    </ul>
                                </span>
                            </label>
                            <!-- TODO: Add clarifying text when "No" is selected - Design needed for "Why are you declining?" message -->
                        </div>
                    </div>

                    <!-- ============================================ -->
                    <!-- SECTION 10: Declaration -->
                    <!-- ============================================ -->
                    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #10b981;">
                        <h4 style="color: #1e293b; margin-bottom: 15px; font-size: 1rem;">
                            ‚úÖ Section 10: Declaration
                        </h4>
                        
                        <div>
                            <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="declarationConsent" value="true" style="margin-top: 4px;" required>
                                <span style="color: #475569; line-height: 1.6; font-size: 0.95rem;">
                                    <strong>10:</strong> By signing below, I confirm that I:
                                    <ul style="margin: 8px 0 0 20px; padding: 0;">
                                        <li>Have read and understood this consent form</li>
                                        <li>Consent to the activities outlined in this consent form</li>
                                        <li>Will have the opportunity to ask questions about this consent form at any time</li>
                                    </ul>
                                </span>
                            </label>
                            <!-- TODO: Add clarifying text when "No" is selected - Design needed for "Why are you declining?" message -->
                        </div>
                    </div>

                </div>

                <!-- ============================================ -->
                <!-- SIGNATURE SECTION -->
                <!-- ============================================ -->
                <div style="background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 242, 254, 0.1)); padding: 25px; border-radius: 12px; margin-top: 20px; border: 2px solid #4facfe;">
                    <h4 style="color: #1e293b; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; font-size: 1rem;">
                        ‚úçÔ∏è Your Signature
                    </h4>
                    <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 15px;">
                        Sign below to confirm you have read and agree to all sections of this consent form.
                    </p>
                    
                    <div style="background: white; border: 2px dashed #4facfe; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <canvas id="signatureCanvas" width="560" height="150" style="width: 100%; border-radius: 4px; background: #fafafa; cursor: crosshair;"></canvas>
                        <input type="hidden" name="clientSignatureData" id="clientSignatureInput" value="">
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="clearSignature()">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                            </svg>
                            Clear Signature
                        </button>
                    </div>
                </div>

                <!-- FORM ACTIONS -->
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/>
                        </svg>
                        Submit Consent Form
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeSignModal()">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

<!-- ========================================== -->
<!-- LOCATION BLOCK 7: TOAST NOTIFICATION -->
<!-- ========================================== -->
    <div id="toast" class="toast"></div>

<!-- ========================================== -->
<!-- LOCATION BLOCK 8: JAVASCRIPT -->
<!-- ========================================== -->
    <script>
        // ===== INITIALIZATION =====
        let canvas, ctx, drawing = false;
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

        window.addEventListener('load', function() {
            // Show welcome toast for first login
            <% if (session.isFirstLogin) { %>
            setTimeout(() => {
                showToast('Welcome to your secure portal, <%= client.firstName %>! üéâ', 'success');
            }, 1000);
            <% } %>

            // Set consent date
            const now = new Date();
            document.getElementById('consentDate').textContent = now.toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        });

        // ===== NOTIFICATION PANEL =====
        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            panel.classList.toggle('show');
        }

        function markAsRead(element, notifId) {
            if (element.classList.contains('unread')) {
                fetch(`/api/notifications/${notifId}/read`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include'
                }).then(response => {
                    if (response.ok) {
                        element.classList.remove('unread');
                        updateNotificationBadge();
                    }
                }).catch(_err => {
                    console.error('Failed to mark notification as read');
                });
            }
        }

        function updateNotificationBadge() {
            fetch('/api/notifications/count', {
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                const badge = document.querySelector('.notification-badge');
                if (data.unreadCount > 0) {
                    if (badge) {
                        badge.textContent = data.unreadCount;
                    } else {
                        const bell = document.querySelector('.notification-bell');
                        const newBadge = document.createElement('span');
                        newBadge.className = 'notification-badge';
                        newBadge.textContent = data.unreadCount;
                        bell.appendChild(newBadge);
                    }
                } else if (badge) {
                    badge.remove();
                }
            })
            .catch(_err => {
                console.error('Failed to update notification badge');
            });
        }

        // ===== TOAST NOTIFICATION =====
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast toast-${type} show`;

            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // ===== SIGNATURE MODAL =====
        function openSignModal() {
            document.getElementById('signModal').classList.add('show');
            setTimeout(() => {
                initCanvas();
            }, 100);
        }

        function closeSignModal() {
            document.getElementById('signModal').classList.remove('show');
        }

        function initCanvas() {
            canvas = document.getElementById('signatureCanvas');
            if (!canvas) return;
            
            ctx = canvas.getContext('2d');

            // Set canvas dimensions (fixed for consistency)
            canvas.width = 560;
            canvas.height = 150;

            ctx.strokeStyle = '#2d3748';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';

            // Remove old listeners to prevent duplicates
            canvas.removeEventListener('mousedown', startDrawing);
            canvas.removeEventListener('mousemove', draw);
            canvas.removeEventListener('mouseup', stopDrawing);
            canvas.removeEventListener('mouseout', stopDrawing);
            canvas.removeEventListener('touchstart', handleTouch);
            canvas.removeEventListener('touchmove', handleTouch);
            canvas.removeEventListener('touchend', stopDrawing);

            // Add event listeners
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            drawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        }

        function draw(e) {
            if (!drawing) return;
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
        }

        function stopDrawing() {
            drawing = false;
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;

            if (e.type === 'touchstart') {
                drawing = true;
                ctx.beginPath();
                ctx.moveTo(x, y);
            } else if (e.type === 'touchmove' && drawing) {
                ctx.lineTo(x, y);
                ctx.stroke();
            }
        }

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('clientSignatureInput').value = '';
            showToast('Signature cleared', 'info');
        }

        // FORM SUBMISSION HANDLER (SERVER-SIDE)
        // Capture signature data before form submits
        document.addEventListener('DOMContentLoaded', function() {
            const consentForm = document.getElementById('consentForm');
            if (consentForm) {
                consentForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Validate signature exists
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const hasSignature = imageData.data.some(channel => channel !== 0);
                    
                    if (!hasSignature) {
                        showToast('Please provide your signature before submitting', 'warning');
                        return false;
                    }
                    
                    // Capture signature as base64 and add to hidden input
                    const signatureDataURL = canvas.toDataURL('image/png');
                    document.getElementById('clientSignatureInput').value = signatureDataURL;
                    
                    // Show processing message
                    showToast('Submitting your consent form...', 'info');
                    
                    // Submit form to server
                    consentForm.submit();
                });
            }
        });

        // ===== DOCUMENT & REPORT FUNCTIONS =====
        function downloadForm() {
            showToast('Preparing consent form for download...', 'info');
            window.location.href = '/consent/download';
        }

        function viewDocuments() {
            showToast('Opening document vault...', 'info');
            window.location.href = '/documents';
        }

        function viewReport() {
            showToast('Opening final report...', 'info');
            window.location.href = '/report/view';
        }

        // ===== CLOSE MODAL ON OUTSIDE CLICK =====
        window.onclick = function(event) {
            const modal = document.getElementById('signModal');
            const notifPanel = document.getElementById('notificationPanel');

            if (event.target === modal) {
                closeSignModal();
            }

            if (!event.target.closest('.notification-panel') && !event.target.closest('.notification-bell')) {
                notifPanel.classList.remove('show');
            }
        };

        // ===== RIPPLE EFFECT =====
        document.querySelectorAll('.btn:not([disabled])').forEach(btn => {
            btn.addEventListener('click', function(e) {
                if (this.querySelector('.ripple')) return;

                const ripple = document.createElement('span');
                const rect = this.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;

                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                ripple.classList.add('ripple');

                this.appendChild(ripple);

                setTimeout(() => {
                    ripple.remove();
                }, 600);
            });
        });
    </script>
</body>
</html>
