<!-- ==============================================
     clients-2fa.ejs - Clients 2FA Verification Page
     QOLAE Clients Portal - Step 2: Email Verification Code Entry
     Author: Liz
     Date: 27th December 2025
     ✅ BLOCKCHAIN COMPLIANT: Server-side form POST, no fetch()
     ============================================== -->

<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ==============================================
         LOCATION BLOCK A: META & CONFIGURATION
         ============================================== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Code - QOLAE Portal</title>

    <!-- ==============================================
         LOCATION BLOCK B: STYLES
         B.1: Reset & Base Styles
         B.2: QOLAE Logo
         B.3: Layout Container
         B.4: 2FA Card
         B.5: Code Input Boxes
         B.6: Buttons
         B.7: Messages
         B.8: Timer
         B.9: Responsive Design
         ============================================== -->

    <style>
        /* ============================================== */
        /* B.1: RESET & BASE STYLES */
        /* ============================================== */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            margin: 0;
        }

        /* ============================================== */
        /* B.2: QOLAE LOGO */
        /* ============================================== */

        .qolae-logo {
            margin-bottom: 60px;
            text-align: center;
            background: none;
            border: none;
            box-shadow: none;
        }

        .qolae-logo img {
            max-width: 1200px;
            width: 110%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        /* ============================================== */
        /* B.3: LAYOUT CONTAINER */
        /* ============================================== */

        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 500px;
        }

        /* ============================================== */
        /* B.4: 2FA CARD - BASKERVILLE FONT */
        /* ============================================== */

        .twofa-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            border: 1px solid #e9ecef;
            font-family: 'Baskerville', 'Helvetica Neue', serif;
        }

        .twofa-title {
            color: #4facfe;
            font-size: 1.5rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 10px;
            font-family: 'Baskerville', 'Helvetica Neue', serif;
        }

        .welcome-text {
            text-align: center;
            margin-bottom: 24px;
        }

        .welcome-text h2 {
            color: #2d3748;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .welcome-text p {
            color: #6b7280;
            font-size: 14px;
        }

        .step-indicator {
            text-align: center;
            margin-bottom: 24px;
            color: #4facfe;
            font-size: 14px;
            font-weight: 600;
        }

        /* ============================================== */
        /* B.5: CODE INPUT BOXES */
        /* ============================================== */

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            color: #374151;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 14px;
            text-align: center;
        }

        .code-input-container {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 16px;
        }

        .code-input {
            width: 50px;
            height: 60px;
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            border: 2px solid #4facfe;
            border-radius: 8px;
            transition: all 0.3s;
            font-family: Arial, sans-serif;
        }

        .code-input:focus {
            outline: none;
            border-color: #00c9d8;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
        }

        /* Hidden input for full code submission */
        .hidden-code-input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .email-display {
            text-align: center;
            color: #6b7280;
            font-size: 13px;
            margin-top: 12px;
        }

        .email-display span {
            color: #4facfe;
            font-weight: 600;
        }

        /* ============================================== */
        /* B.6: BUTTONS - TURQUOISE */
        /* ============================================== */

        .verify-btn {
            width: 100%;
            padding: 14px 20px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: Arial, sans-serif;
        }

        .verify-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);
        }

        .verify-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .resend-btn {
            display: block;
            width: 100%;
            background: transparent;
            color: #4facfe;
            border: none;
            padding: 12px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 16px;
            text-align: center;
        }

        .resend-btn:hover {
            color: #00c9d8;
        }

        /* ============================================== */
        /* B.7: MESSAGES */
        /* ============================================== */

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
        }

        .success-message {
            background: #dcfce7;
            border: 1px solid #bbf7d0;
            color: #16a34a;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
        }

        .info-message {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            color: #0369a1;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
        }

        /* ============================================== */
        /* B.8: TIMER */
        /* ============================================== */

        .timer {
            text-align: center;
            color: #6b7280;
            font-size: 13px;
            margin-top: 12px;
        }

        .timer.expired {
            color: #dc2626;
        }

        .timer .countdown {
            font-weight: 600;
            color: #4facfe;
        }

        /* ============================================== */
        /* B.9: BACK LINK & SECURITY */
        /* ============================================== */

        .back-link {
            text-align: center;
            margin-top: 20px;
        }

        .back-link a {
            color: #6b7280;
            font-size: 13px;
            text-decoration: none;
        }

        .back-link a:hover {
            color: #4facfe;
        }

        .security-notice {
            margin-top: 24px;
            padding: 12px;
            background: #f8f9ff;
            border-radius: 8px;
            border-left: 3px solid #4facfe;
        }

        .security-notice p {
            color: #6b7280;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ============================================== */
        /* B.10: SPINNER ANIMATION */
        /* ============================================== */

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============================================== */
        /* B.11: RESPONSIVE DESIGN */
        /* ============================================== */

        @media (max-width: 768px) {
            .qolae-logo img {
                max-width: 300px;
            }

            .twofa-card {
                padding: 30px 25px;
            }

            .code-input {
                width: 42px;
                height: 52px;
                font-size: 20px;
            }
        }
    </style>
</head>

<body>
    <!-- ==============================================
         LOCATION BLOCK C: HTML STRUCTURE
         C.1: QOLAE Logo
         C.2: Main Container
         C.3: 2FA Card
         C.4: Server-Side Messages
         C.5: Verification Form (Server-side POST)
         C.6: Resend Form (Server-side POST)
         C.7: Back Link
         ============================================== -->

    <!-- C.1: QOLAE Logo at Top -->
    <div class="qolae-logo">
        <img src="/central-repository/public/images/qolaeNewLogo.png"
             alt="QOLAE Logo"
             onerror="this.style.display='none'">
    </div>

    <!-- C.2: Main Container -->
    <div class="main-container">
        <!-- C.3: 2FA Card -->
        <div class="twofa-card">
            <h2 class="twofa-title">Email Verification</h2>

            <div class="welcome-text">
                <h2>Welcome, <%= clientName %></h2>
                <p>We've sent a verification code to your email</p>
            </div>

            <!-- C.4: Server-Side Messages -->
            <% if (typeof error !== 'undefined' && error) { %>
                <div class="error-message"><%= error %></div>
            <% } %>

            <% if (typeof codeSent !== 'undefined' && codeSent) { %>
                <div class="success-message">Verification code sent to your email!</div>
            <% } %>

            <div class="step-indicator">Step 2 of 2: Enter Verification Code</div>

            <!-- C.5: ✅ SERVER-SIDE FORM: No fetch(), posts directly to backend -->
            <form id="verifyForm" method="POST" action="/clients-auth/verify-code">
                <!-- Hidden fields for PIN and email -->
                <input type="hidden" name="pin" value="<%= pin %>">
                <input type="hidden" name="email" value="<%= email %>">
                <!-- Hidden field for combined verification code -->
                <input type="hidden" name="verificationCode" id="verificationCodeHidden" value="">

                <div class="form-group">
                    <label class="form-label">6-Digit Verification Code</label>
                    <div class="code-input-container">
                        <input type="text" class="code-input" maxlength="1" data-index="0" inputmode="numeric" pattern="[0-9]" autocomplete="one-time-code">
                        <input type="text" class="code-input" maxlength="1" data-index="1" inputmode="numeric" pattern="[0-9]">
                        <input type="text" class="code-input" maxlength="1" data-index="2" inputmode="numeric" pattern="[0-9]">
                        <input type="text" class="code-input" maxlength="1" data-index="3" inputmode="numeric" pattern="[0-9]">
                        <input type="text" class="code-input" maxlength="1" data-index="4" inputmode="numeric" pattern="[0-9]">
                        <input type="text" class="code-input" maxlength="1" data-index="5" inputmode="numeric" pattern="[0-9]">
                    </div>
                    <p class="email-display">Code sent to <span><%= email %></span></p>
                    <p class="timer" id="timer">Code expires in <span class="countdown" id="countdown">10:00</span></p>
                </div>

                <button type="submit" class="verify-btn" id="verifyBtn">Verify & Login</button>
            </form>

            <!-- C.6: ✅ SERVER-SIDE RESEND FORM: No fetch() -->
            <form id="resendForm" method="POST" action="/clients-auth/resend-code">
                <input type="hidden" name="pin" value="<%= pin %>">
                <input type="hidden" name="email" value="<%= email %>">
                <button type="submit" class="resend-btn" id="resendBtn">Resend Code</button>
            </form>

            <!-- C.7: Back Link -->
            <div class="back-link">
                <a href="/clients-login?pin=<%= pin %>">← Back to login</a>
            </div>

            <!-- Security Notice -->
            <div class="security-notice">
                <p>
                    <svg width="16" height="16" fill="#4facfe" viewBox="0 0 24 24">
                        <path d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1M10,17L6,13L7.41,11.59L10,14.17L16.59,7.58L18,9L10,17Z"/>
                    </svg>
                    Your session is encrypted and GDPR compliant
                </p>
            </div>
        </div>
    </div>

    <!-- ==============================================
         LOCATION BLOCK D: JAVASCRIPT (UI ONLY)
         ✅ BLOCKCHAIN COMPLIANT: No fetch() calls
         D.1: Code Input Navigation (UI Enhancement)
         D.2: Form Submit Handler (combines code)
         D.3: Countdown Timer (UI only)
         D.4: Form Loading States
         ============================================== -->

    <script>
        // ==============================================
        // D.1: CODE INPUT NAVIGATION
        // Handles digit-by-digit entry and auto-advance
        // ==============================================

        const codeInputs = document.querySelectorAll('.code-input');
        const verificationCodeHidden = document.getElementById('verificationCodeHidden');

        // Focus first input on load
        window.addEventListener('DOMContentLoaded', () => {
            codeInputs[0].focus();
        });

        // Update hidden field with combined code
        function updateHiddenCode() {
            const code = Array.from(codeInputs).map(input => input.value).join('');
            verificationCodeHidden.value = code;
            return code;
        }

        // Handle code input navigation
        codeInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                const value = e.target.value;

                // Only allow numbers
                if (!/^\d*$/.test(value)) {
                    e.target.value = '';
                    return;
                }

                // Update hidden code field
                updateHiddenCode();

                // Move to next input
                if (value && index < codeInputs.length - 1) {
                    codeInputs[index + 1].focus();
                }
            });

            input.addEventListener('keydown', (e) => {
                // Handle backspace
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    codeInputs[index - 1].focus();
                }
            });

            // Handle paste
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const pastedData = e.clipboardData.getData('text').trim();

                if (/^\d{6}$/.test(pastedData)) {
                    pastedData.split('').forEach((char, i) => {
                        if (codeInputs[i]) {
                            codeInputs[i].value = char;
                        }
                    });
                    codeInputs[5].focus();
                    updateHiddenCode();
                }
            });
        });

        // ==============================================
        // D.2: FORM SUBMIT HANDLER
        // Validates code and updates hidden field before POST
        // ✅ No fetch() - form posts directly to server
        // ==============================================

        document.getElementById('verifyForm').addEventListener('submit', function(e) {
            const code = updateHiddenCode();

            if (code.length !== 6) {
                e.preventDefault();
                alert('Please enter all 6 digits');
                codeInputs[0].focus();
                return;
            }

            // Show loading state (form will POST to server)
            const verifyBtn = document.getElementById('verifyBtn');
            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<span class="spinner"></span>Verifying...';
        });

        // ==============================================
        // D.3: COUNTDOWN TIMER (UI ONLY)
        // Just visual countdown - expiry enforced server-side
        // ==============================================

        let timeLeft = 600; // 10 minutes
        const countdownEl = document.getElementById('countdown');
        const timerEl = document.getElementById('timer');

        const timerInterval = setInterval(() => {
            timeLeft--;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            countdownEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                timerEl.classList.add('expired');
                timerEl.innerHTML = 'Code expired. Please click "Resend Code" below.';
            }
        }, 1000);

        // ==============================================
        // D.4: RESEND FORM LOADING STATE
        // ✅ No fetch() - form posts directly to server
        // ==============================================

        document.getElementById('resendForm').addEventListener('submit', function(e) {
            const resendBtn = document.getElementById('resendBtn');
            resendBtn.disabled = true;
            resendBtn.textContent = 'Sending...';
        });
    </script>
</body>
</html>
